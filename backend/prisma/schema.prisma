generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(uuid())
  walletAddress   String    @unique
  privyUserId     String?   @unique
  username        String?
  userType        UserType  @default(HUMAN)
  reputationScore Float     @default(0)
  
  // Stats
  jobsPosted      Int       @default(0)
  jobsCompleted   Int       @default(0)
  totalEarned     Float     @default(0)
  totalSpent      Float     @default(0)
  disputeWins     Int       @default(0)
  disputeLosses   Int       @default(0)
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  postedJobs      Job[]     @relation("JobPoster")
  acceptedJobs    Job[]     @relation("JobWorker")
  jurorVotes      JurorVote[]
  
  @@index([walletAddress])
  @@index([reputationScore])
}

model Agent {
  id              String    @id @default(uuid())
  name            String    @unique
  description     String?
  walletAddress   String    @unique
  privyWalletId   String    @unique  // Privy internal wallet ID
  
  // Capabilities & Configuration
  capabilities    String[]  // e.g., ['code_review', 'content_generation']
  webhookUrl      String?   // For async notifications
  
  // Status
  status          AgentStatus @default(ACTIVE)
  
  // Stats
  reputationScore Float     @default(0)
  jobsPosted      Int       @default(0)
  jobsCompleted   Int       @default(0)
  totalEarned     Float     @default(0)
  totalSpent      Float     @default(0)
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  jobsPosted_rel  Job[]     @relation("AgentPoster")
  jobsWorked_rel  Job[]     @relation("AgentWorker")
  transactions    Transaction[]
  
  @@index([walletAddress])
  @@index([status])
  @@index([reputationScore])
}

model Transaction {
  id              String    @id @default(uuid())
  
  // Relations
  agentId         String
  agent           Agent     @relation(fields: [agentId], references: [id])
  
  // Transaction details
  from            String    // From address
  to              String    // To address
  amount          Float
  currency        Currency  @default(USDC)
  
  // Optional context
  jobId           String?
  
  // On-chain
  transactionHash String?
  status          TransactionStatus @default(PENDING)
  
  // Timestamps
  createdAt       DateTime  @default(now())
  confirmedAt     DateTime?
  
  @@index([agentId])
  @@index([status])
  @@index([transactionHash])
}

model Job {
  id                String      @id @default(uuid())
  
  // Relations (Users)
  posterId          String?
  poster            User?       @relation("JobPoster", fields: [posterId], references: [id])
  workerId          String?
  worker            User?       @relation("JobWorker", fields: [workerId], references: [id])
  
  // Relations (Agents)
  posterAgentId     String?
  posterAgent       Agent?      @relation("AgentPoster", fields: [posterAgentId], references: [id])
  workerAgentId     String?
  workerAgent       Agent?      @relation("AgentWorker", fields: [workerAgentId], references: [id])
  
  // Job details
  title             String
  description       String
  budget            Float       // USDC amount
  status            JobStatus   @default(OPEN)
  
  // Timing
  createdAt         DateTime    @default(now())
  deadline          DateTime
  completedAt       DateTime?
  
  // Categories
  category          JobCategory @default(OTHER)
  proofType         ProofType   @default(MANUAL)
  
  // For physical jobs
  locationLat       Float?
  locationLng       Float?
  locationRadius    Int?        // meters
  
  // Squads escrow
  squadsVaultAddress String?
  
  // Work submission
  deliverableUrl    String?
  deliverableHash   String?
  proofData         Json?       // EXIF data, test results, etc.
  
  // Relations
  dispute           Dispute?
  jurorVotes        JurorVote[]
  
  @@index([status])
  @@index([posterId])
  @@index([workerId])
  @@index([posterAgentId])
  @@index([workerAgentId])
  @@index([category])
}

model Dispute {
  id            String        @id @default(uuid())
  jobId         String        @unique
  job           Job           @relation(fields: [jobId], references: [id])
  
  status        DisputeStatus @default(OPEN)
  initiatedBy   String        // wallet address
  
  // Voting
  commitDeadline DateTime?
  revealDeadline DateTime?
  
  // Result
  winnerAddress  String?       // who won the dispute
  resolution     String?       // explanation
  resolvedAt     DateTime?
  
  // Jurors
  jurorVotes    JurorVote[]
  
  createdAt     DateTime      @default(now())
  
  @@index([status])
}

model JurorVote {
  id          String    @id @default(uuid())
  
  disputeId   String
  dispute     Dispute   @relation(fields: [disputeId], references: [id])
  
  jobId       String
  job         Job       @relation(fields: [jobId], references: [id])
  
  jurorId     String
  juror       User      @relation(fields: [jurorId], references: [id])
  
  // Commit-reveal
  commitHash  String?   // hashed vote
  vote        String?   // 'poster' | 'worker' | 'split' (revealed)
  stakeAmount Float     @default(10) // USDC
  
  // Result
  isWinner    Boolean?
  reward      Float?    // USDC reward for correct vote
  
  createdAt   DateTime  @default(now())
  revealedAt  DateTime?
  
  @@unique([disputeId, jurorId])
}

enum UserType {
  HUMAN
  AGENT
}

enum AgentStatus {
  ACTIVE
  PAUSED
  SUSPENDED
}

enum Currency {
  SOL
  USDC
}

enum TransactionStatus {
  PENDING
  CONFIRMED
  FAILED
}

enum JobStatus {
  OPEN
  LOCKED
  SUBMITTED
  COMPLETED
  DISPUTED
  REFUNDED
  EXPIRED
}

enum JobCategory {
  CODE
  DESIGN
  CONTENT
  DATA
  VERIFICATION
  OTHER
}

enum ProofType {
  MANUAL
  CODE
  CONTENT
  PHYSICAL
}

enum DisputeStatus {
  OPEN
  COMMIT
  REVEAL
  RESOLVED
}
